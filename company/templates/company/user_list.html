{% extends 'company/base.html' %}
{% load humanize %}
{% load i18n %}
{% load common_tags %}

{% block title %}{% trans 'User List - Super Insurance' %}{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item active" aria-current="page">{% trans 'User List' %}</li>
{% endblock %}

{% block company_content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{% trans 'User List' %}</h1>
        <a href="javascript:history.back()" class="btn btn-secondary">{% trans 'Back' %}</a>
    </div>

    <div class="card p-3 mb-4">
        <div class="row g-3 align-items-center">
            <div class="col-md-6">
                <form method="get" action="{% url 'company:user_list' %}">
                    <div class="input-group">
                        <input type="text" name="q" class="form-control" placeholder="{% trans 'Search by username or email...' %}" value="{{ query }}">
                        <button class="btn btn-primary" type="submit">{% trans 'Search' %}</button>
                    </div>
                </form>
            </div>
            <div class="col-md-6 d-flex justify-content-end">
                {# Pagination controls will go here #}
            </div>
        </div>
    </div>
    <div class="card p-3">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>{% trans 'Username' %}</th>
                        <th>{% trans 'Email' %}</th>
                        <th>{% trans 'Policies' %}</th>
                        <th>{% trans 'Solicitations' %}</th>
                        <th>{% trans 'Actions' %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in paginated_users %}
                    <tr data-user-id="{{ user.id }}">
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.policy_count }}</td>
                        <td>{{ user.solicitation_count }}</td>
                        <td>
                            <a href="{% url 'company:add_policy_to_user' user.id %}" class="btn btn-sm btn-success">{% trans 'Add Policy' %}</a>
                            <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#policies-{{ user.id }}" aria-expanded="false" aria-controls="policies-{{ user.id }}">
                                {% trans 'View Policies' %}
                            </button>
                            <a href="{% url 'company:user_solicitations' user.id %}" class="btn btn-sm btn-warning">{% trans 'View Solicitations' %}</a>
                        </td>
                    </tr>
                    <tr class="collapse accordion-collapse" id="policies-{{ user.id }}" data-bs-parent="#userAccordion">
                        <td colspan="5">
                            <div class="accordion accordion-flush" id="userPoliciesAccordion-{{ user.id }}">
                                {% with user_policies_data=users_with_policies|get_item:user %}
                                    {% if user_policies_data.policies %}
                                        {% for user_policy in user_policies_data.policies %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="headingPolicy-{{ user_policy.id }}">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePolicy-{{ user_policy.id }}" aria-expanded="false" aria-controls="collapsePolicy-{{ user.id }}">
                                                    {{ user_policy.policy.name }} ({{ user_policy.policy.policy_number }})
                                                </button>
                                            </h2>
                                            <div id="collapsePolicy-{{ user_policy.id }}" class="accordion-collapse collapse" aria-labelledby="headingPolicy-{{ user_policy.id }}" data-bs-parent="#userPoliciesAccordion-{{ user.id }}">
                                                <div class="accordion-body">
                                                    <p><strong>{% trans 'Policy Type' %}:</strong> {{ user_policy.policy.get_policy_type_display }}</p>
                                                    <p><strong>{% trans 'Coverage Amount' %}:</strong> {{ user_policy.policy.coverage_amount|intcomma }}</p>
                                                    <p><strong>{% trans 'Status' %}:</strong> 
                                                        {% if user_policy.policy.is_active %}
                                                            <span class="badge bg-success">{% trans 'Active' %}</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">{% trans 'Inactive' %}</span>
                                                        {% endif %}
                                                    </p>
                                                    <p><strong>{% trans 'Start Date' %}:</strong> {{ user_policy.start_date|default:"N/A" }}</p>
                                                    <p><strong>{% trans 'End Date' %}:</strong> {{ user_policy.end_date|default:"N/A" }}</p>
                                                    <div class="d-flex gap-2">
                                                        <a href="{% url 'company:policy_details' user_policy.policy.id %}" class="btn btn-outline-secondary btn-sm">{% trans 'Details' %}</a>
                                                        <a href="{% url 'company:edit_user_policy' user_policy.id %}" class="btn btn-outline-primary btn-sm">{% trans 'Edit' %}</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="p-3">{% trans 'No policies assigned.' %}</p>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">{% trans 'No users found.' %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if paginated_users.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1&q={{ query }}">&laquo; {% trans 'first' %}</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ paginated_users.previous_page_number }}&q={{ query }}">{% trans 'previous' %}</a></li>
            {% endif %}

            <li class="page-item disabled"><span class="page-link">{% trans 'Page' %} {{ paginated_users.number }} {% trans 'of' %} {{ paginated_users.paginator.num_pages }}.</span></li>

            {% if paginated_users.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ paginated_users.next_page_number }}&q={{ query }}">{% trans 'next' %}</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ paginated_users.paginator.num_pages }}&q={{ query }}">{% trans 'last' %} &raquo;</a></li>
            {% endif %}
        </ul>
    </nav>
{% endblock %}
